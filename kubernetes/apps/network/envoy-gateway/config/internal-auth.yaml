
---
# Gateway for handling OAuth callbacks
# This gateway should NOT have OIDC protection itself
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: envoy-internal-auth
  namespace: network
  labels:
    gateway-type: internal
  annotations:
    external-dns.alpha.kubernetes.io/target: &hostname envoy-int-auth.${SECRET_DOMAIN}
spec:
  gatewayClassName: envoy
  infrastructure:
    annotations:
      external-dns.alpha.kubernetes.io/hostname: *hostname
      lbipam.cilium.io/ips: 10.30.6.45
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same
    - name: https
      protocol: HTTPS
      port: 443
      allowedRoutes:
        namespaces:
          from: All
      tls:
        certificateRefs:
          - kind: Secret
            name: home-ops-jmn-tls
---
# SecurityPolicy should be on the gateway/routes you want to PROTECT
# NOT on the auth callback gateway itself
# Apply this to services that need authentication
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-auth-policy
  namespace: network  # or the namespace of your protected service
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute  # or Gateway if you want to protect all routes
    name: your-protected-service-route  # Change to your actual route name
  oidc:
    provider:
      issuer: "https://sso.${SECRET_DOMAIN}/application/o/envoy-gateway/"
      authorizationEndpoint: "https://sso.${SECRET_DOMAIN}/application/o/authorize/"
      tokenEndpoint: "https://sso.${SECRET_DOMAIN}/application/o/token/"
    clientID: "XUzfQuGJXOB4vzKRCGzHc4d3EqR1MgXaLr8DfRRl"
    clientSecret:
      name: authentik-oidc-secret
    redirectURL: "https://envoy-int-auth.${SECRET_DOMAIN}/oauth2/callback"
    logoutPath: "/oauth2/logout"
    scopes:
      - openid
      - profile
      - email
    cookieDomain: ".${SECRET_DOMAIN}"  # Add this!
---
# HTTPRoute for OAuth callback - should NOT route to a backend
# Instead, remove this HTTPRoute entirely and let Envoy handle it internally
# The SecurityPolicy's redirectURL will automatically create the callback endpoint
---
# Example: Protecting a service with OAuth
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: protected-service-example
  namespace: network
spec:
  hostnames:
    - myapp.${SECRET_DOMAIN}
  parentRefs:
    - name: envoy-internal  # Your main internal gateway
      namespace: network
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: your-actual-service
          namespace: network
          port: 8080
---
# Apply SecurityPolicy to the HTTPRoute above
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: protected-service-auth
  namespace: network
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: protected-service-example  # Match the HTTPRoute name above
  oidc:
    provider:
      issuer: "https://sso.${SECRET_DOMAIN}/application/o/envoy-gateway/"
      authorizationEndpoint: "https://sso.${SECRET_DOMAIN}/application/o/authorize/"
      tokenEndpoint: "https://sso.${SECRET_DOMAIN}/application/o/token/"
    clientID: "XUzfQuGJXOB4vzKRCGzHc4d3EqR1MgXaLr8DfRRl"
    clientSecret:
      name: authentik-oidc-secret
    redirectURL: "https://envoy-int-auth.${SECRET_DOMAIN}/oauth2/callback"
    logoutPath: "/oauth2/logout"
    scopes:
      - openid
      - profile
      - email
    cookieDomain: ".${SECRET_DOMAIN}"
---
