---
# EnvoyPatchPolicy to add active health checks, outlier detection and basic retry
# Applies to resources generated for the envoy-internal Gateway
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: proxmox-health
  namespace: network
spec:
  jsonPatches:
    - type: type.googleapis.com/envoy.config.cluster.v3.Cluster
      operation:
        op: add
        jsonPath: "..health_checks"
        value:
          - timeout: 2s
            interval: 5s
            unhealthy_threshold: 3
            healthy_threshold: 2
            http_health_check:
              path: "/"
    - type: type.googleapis.com/envoy.config.cluster.v3.Cluster
      operation:
        op: add
        jsonPath: "..outlier_detection"
        value:
          consecutive_5xx: 3
          interval: 10s
          base_ejection_time: 30s
    - type: type.googleapis.com/envoy.config.route.v3.Route
      operation:
        op: add
        jsonPath: "..route.action"
        value:
          retry_policy:
            retry_on: "5xx,connect-failure,refused-stream"
            num_retries: 2
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: envoy-internal
  type: JSONPatch
