---
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-proxy-config
  namespace: selfhosted
data:
  nginx.conf: |
    events {}
    http {
      server {
        listen 80;

        # Configure DNS resolver for runtime upstream resolution
        resolver 10.96.0.10 valid=30s;

        # Set upstream host at runtime so nginx does not require DNS at config parse
        set $auth_upstream "authentik-server.selfhosted.svc.cluster.local";

        # CORS headers applied at server level (allowed)
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET,POST,OPTIONS,PUT,DELETE" always;
        add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
        add_header Vary Origin always;

        # Respond to preflight requests
        if ($request_method = OPTIONS) {
          return 204;
        }

        location / {
          proxy_set_header Host sso.jaimenet.com;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto https;
          proxy_set_header X-Forwarded-Host sso.jaimenet.com;

          # Use runtime-resolved upstream variable
          proxy_pass http://$auth_upstream:80;
        }
      }
    }
